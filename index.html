
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for arkIQ IoT data management and alerting.">
      
      
      
      
      
        <link rel="next" href="architecture/">
      
      
      <link rel="icon" href="https://media.licdn.com/dms/image/v2/D4E0BAQGm_K9hKOC6iA/company-logo_200_200/B4EZXIsZm.H0AI-/0/1742828837776/arkiq_logo?e=2147483647&v=beta&t=s-mwQWrz3zXGHuindYjJPvLAkCWT5rPnCRMuShekDI8">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>arkIQ Documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#arkiq-system-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="arkIQ Documentation" class="md-header__button md-logo" aria-label="arkIQ Documentation" data-md-component="logo">
      
  <img src="https://thearkiq.com/wp-content/uploads/2024/03/arkIQ-Horizontal-TM-PNG-768x290.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            arkIQ Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="architecture/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="services/auth/" class="md-tabs__link">
          
  
  
  Services

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="arkIQ Documentation" class="md-nav__button md-logo" aria-label="arkIQ Documentation" data-md-component="logo">
      
  <img src="https://thearkiq.com/wp-content/uploads/2024/03/arkIQ-Horizontal-TM-PNG-768x290.png" alt="logo">

    </a>
    arkIQ Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#device-types-on-ttn" class="md-nav__link">
    <span class="md-ellipsis">
      Device Types on TTN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applications-on-ttn" class="md-nav__link">
    <span class="md-ellipsis">
      Applications on TTN
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applications on TTN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#decoders" class="md-nav__link">
    <span class="md-ellipsis">
      Decoders
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-transmission" class="md-nav__link">
    <span class="md-ellipsis">
      Data Transmission
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-data-flow-integration" class="md-nav__link">
    <span class="md-ellipsis">
      AWS Data Flow Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AWS Data Flow Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#receiving-data-on-aws" class="md-nav__link">
    <span class="md-ellipsis">
      Receiving Data on AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Services
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="services/auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auth Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="services/iot-data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IoT Data Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="services/alerting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Alerting Service
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#device-types-on-ttn" class="md-nav__link">
    <span class="md-ellipsis">
      Device Types on TTN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applications-on-ttn" class="md-nav__link">
    <span class="md-ellipsis">
      Applications on TTN
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applications on TTN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#decoders" class="md-nav__link">
    <span class="md-ellipsis">
      Decoders
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-transmission" class="md-nav__link">
    <span class="md-ellipsis">
      Data Transmission
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aws-data-flow-integration" class="md-nav__link">
    <span class="md-ellipsis">
      AWS Data Flow Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AWS Data Flow Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#receiving-data-on-aws" class="md-nav__link">
    <span class="md-ellipsis">
      Receiving Data on AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="arkiq-system-documentation">arkIQ System Documentation</h1>
<p>All arkIQ's LoRaWAN devices are currently on <strong>The Things Stack</strong>.</p>
<p><strong>Server:</strong><br />
<a href="https://smarttechsolutions.nam1.cloud.thethings.industries">https://smarttechsolutions.nam1.cloud.thethings.industries</a></p>
<h2 id="device-types-on-ttn">Device Types on TTN</h2>
<ul>
<li>Leak Sensors  </li>
<li>Toilet Sensors  </li>
<li>Smart Valves  </li>
<li>Smart Metering  </li>
<li>Gas Sensor  </li>
</ul>
<h2 id="applications-on-ttn">Applications on TTN</h2>
<p>TTN applications are defined according to the types of devices.</p>
<h3 id="decoders">Decoders</h3>
<p>Each application's decoder depends on the <strong>device type</strong> and <strong>manufacturer</strong>:</p>
<p>👉 <a href="https://drive.google.com/drive/folders/15QW0Hz2vR1NtYk9xTZh_HomaRUD1GTcr">Decoder Repository on Google Drive</a></p>
<h2 id="data-transmission">Data Transmission</h2>
<p>The Things Stack stores only a limited number of device uplinks.</p>
<p>Therefore, devices send uplinks directly to <strong>AWS</strong> using a private key.</p>
<p><a href="https://www.thethingsindustries.com/docs/integrations/cloud-integrations/aws-iot/">TTN AWS Integration Guide</a></p>
<h2 id="aws-data-flow-integration">AWS Data Flow Integration</h2>
<p>Each application must be configured individually to transmit data to AWS.</p>
<h3 id="receiving-data-on-aws">Receiving Data on AWS</h3>
<p><img alt="TTN AWS Integration Diagram" src="https://arkiq-open-images.s3.us-east-1.amazonaws.com/ttn+aws+integration+diagram.png" /></p>
<ol>
<li>
<p><strong>Uplink sent from TTN to AWS</strong></p>
</li>
<li>
<p><strong>AWS IoT Core</strong> receives the uplinks.<br />
   A separate <strong>IoT Core Rule</strong> is defined for each device type, extracting the necessary information from each uplink.</p>
</li>
<li>
<p>The extracted data is sent to a <strong>dedicated queue</strong> for each device type.</p>
</li>
<li>
<p>Each queue triggers a <strong>separate Lambda function</strong>, which processes the received data and follows a distinct path depending on the device.</p>
</li>
<li>
<p>Alerts<br />
If necessary, alerts are sent via <strong>email</strong> and <strong>SMS</strong>.</p>
</li>
<li>
<p>Database Storage<br />
Processed data is stored in the <strong>database</strong>.</p>
</li>
</ol>
<hr />
<h3 id="lambda-functions">Lambda Functions</h3>
<p>The Lambda functions are the <strong>core</strong> of the system.<br />
They handle all calculations and business logic decisions.</p>
<h1 id="lambda-function-process_browan_water_leak">Lambda Function: <code>Process_browan_water_leak</code></h1>
<h2 id="purpose">Purpose</h2>
<p>Only for Water Leak Devices from Manufacture Browan.</p>
<h2 id="main-operations-and-algorithms">Main Operations and Algorithms:</h2>
<ul>
<li>
<p>Temperature: from Celcius to Fahrenheit</p>
</li>
<li>
<p>Saves all connected gateways in a list and saves it in the database.</p>
</li>
<li>
<p>If it is sidewalk, saves “NN” instead of gateways.</p>
</li>
<li>
<p>Saves data in the browan_water_leak_data table and updates the latest data in the devices_last_data table.</p>
</li>
</ul>
<p>Note: Alerts are not sent by this Lambda. This Lambda sends data to another Lambda (SendAlertNotification) and that one will decide whether to send an alert.</p>
<hr />
<h2 id="input-source">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>BrowanWaterLeakUplinkQueue</code></strong></p>
<h2 id="output-destinations">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>SendAlertNotification</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>browan_water_leak_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json">Input Format (JSON)</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;WL1&quot;,
    &quot;application_id&quot;: &quot;12&quot;,
    &quot;dev_eui&quot;: &quot;0123&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T18:40:24.038707017Z&quot;,
    &quot;battery&quot;: 2.6,
    &quot;humidity&quot;: 58,
    &quot;water_leak&quot;: 1,
    &quot;temperature&quot;: 22.1,
    &quot;button_pressed&quot;: 0,
    &quot;tamper&quot;: 0,
    &quot;f_cnt&quot;: 2069,
    &quot;metadata&quot;: [
        {
            &quot;gateway_ids&quot;: {
                &quot;gateway_id&quot;: &quot;gid&quot;,
                &quot;eui&quot;: &quot;1234&quot;
            },
            &quot;time&quot;: &quot;2025-07-02T18:40:24.038707017Z&quot;,
            &quot;timestamp&quot;: 2136602948,
            &quot;rssi&quot;: -112,
            &quot;channel_rssi&quot;: -112,
            &quot;snr&quot;: 1,
            &quot;uplink_token&quot;: &quot;abcd=&quot;,
            &quot;received_at&quot;: &quot;2025-07-02T18:40:23.906695800Z&quot;
        }
    ]
}
</code></pre>
<h1 id="lambda-function-process_senospace">Lambda Function: <code>Process_senospace</code></h1>
<h2 id="purpose_1">Purpose</h2>
<p>Only for Water Leak Devices from Manufacture Senospace. Doesn't include Toilet Sensors</p>
<h2 id="main-operations-and-algorithms_1">Main Operations and Algorithms:</h2>
<ul>
<li>
<p>Temperature: from Celcius to Fahrenheit</p>
</li>
<li>
<p>Saves all connected gateways in a list and saves it in the database.</p>
</li>
<li>
<p>Saves data in the browan_water_leak_data table and updates the latest data in the devices_last_data table.</p>
</li>
</ul>
<p>Note: Alerts are not sent by this Lambda. This Lambda sends data to another Lambda (SendAlertNotification) and that one will decide whether to send an alert.</p>
<hr />
<h2 id="input-source_1">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>senospace_uplink_queue</code></strong></p>
<h2 id="output-destinations_1">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>SendAlertNotification</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>senospace_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json_1">Input Format (JSON)</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;123&quot;,
    &quot;application_id&quot;: &quot;app1&quot;,
    &quot;dev_eui&quot;: &quot;1234&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T19:16:38.982846975Z&quot;,
    &quot;payload_type&quot;: &quot;Heartbeat&quot;,
    &quot;payload_type_id&quot;: 1,
    &quot;battery_percentage&quot;: 38,
    &quot;battery_voltage&quot;: 3.16,
    &quot;external_leak_detection_enabled&quot;: true,
    &quot;pin_leak_detection_enabled&quot;: true,
    &quot;tamper_detection_enabled&quot;: true,
    &quot;humidity&quot;: 54.2,
    &quot;last_rssi&quot;: -42,
    &quot;last_snr&quot;: 13,
    &quot;external_leak_detected&quot;: false,
    &quot;jack_detected&quot;: false,
    &quot;magnet_detected&quot;: false,
    &quot;pin_leak_detected&quot;: false,
    &quot;power_detected&quot;: false,
    &quot;state_as_uint8&quot;: 7,
    &quot;temperature&quot;: 24.33,
    &quot;frame_count&quot;: 2677,
    &quot;metadata&quot;: [
        {
            &quot;gateway_ids&quot;: {
                &quot;gateway_id&quot;: &quot;eui-58a0cbfffe8040c1&quot;,
                &quot;eui&quot;: &quot;58A0CBFFFE8040C1&quot;
            },
            &quot;time&quot;: &quot;2025-07-02T19:16:38.982846975Z&quot;,
            &quot;timestamp&quot;: 2143403483,
            &quot;rssi&quot;: -63,
            &quot;channel_rssi&quot;: -63,
            &quot;snr&quot;: 9.25,
            &quot;uplink_token&quot;: &quot;CiIKIAoUZXVpLTU4YTBjYmZmZmU4MDQwYzESCFigy//+gEDBENv7hv4HGgwIl4uWwwYQyZ28jAEg+L625rA+&quot;,
            &quot;received_at&quot;: &quot;2025-07-02T19:16:39.241239981Z&quot;
        },
        {
            &quot;gateway_ids&quot;: {
                &quot;gateway_id&quot;: &quot;iqgw-tk-20&quot;,
                &quot;eui&quot;: &quot;647FDAFFFE01F36D&quot;
            },
            &quot;timestamp&quot;: 1245444315,
            &quot;rssi&quot;: -78,
            &quot;channel_rssi&quot;: -78,
            &quot;snr&quot;: 9.5,
            &quot;uplink_token&quot;: &quot;ChgKFgoKaXFndy10ay0yMBIIZH/a//4B820Q2/Hv0QQaDAiXi5bDBhCLqciXASD4rpDSn+UU&quot;,
            &quot;received_at&quot;: &quot;2025-07-02T19:16:39.125916168Z&quot;
        }
    ]
}
</code></pre>
<h1 id="lambda-function-process_long_flush_senospace">Lambda Function: <code>Process_long_flush_senospace</code></h1>
<h2 id="purpose_2">Purpose</h2>
<p>Only for Toilet Sensor Devices from Manufacture Senospace filtered by the uplinks of type LONG_FLUSH (payload_type_id = 10).</p>
<h2 id="main-operations-and-algorithms_2">Main Operations and Algorithms:</h2>
<h3 id="how-does-long-flush-work">How Does Long Flush Work?</h3>
<p>The device only sends the uplink <strong>after 3 minutes (default)</strong> of continuous flushing.<br />
In other words, when the uplink is received, the flushing has already been occurring for 3 minutes.<br />
Because of that, the Lambda must register that the flush <strong>started 3 minutes earlier</strong>.</p>
<hr />
<h3 id="end-of-flush">End of Flush</h3>
<p>When a flush ends, a different type of uplink is sent:<br />
<strong>Last Event Water Usage</strong> (<code>payload_type_id = 11</code>).<br />
However, this uplink is processed by <strong>another Lambda</strong>:<br />
<code>Process_water_usage_senospace</code>.</p>
<hr />
<h3 id="custom-long-flush-duration">Custom Long Flush Duration</h3>
<p>The user can request the device to register a flush <strong>only after 4 or more minutes</strong>. In this case:</p>
<ol>
<li>An external API (not the Lambda) stores on the device the setting that long flush should be recorded after 4+ minutes.</li>
<li>The Lambda checks the device settings in the database.</li>
<li>Based on the setting:</li>
<li><strong>If it's set to 3 minutes (default):</strong><br />
     The long flush is recorded normally.</li>
<li><strong>If it's set to more than 3 minutes (late long flush):</strong>  <ul>
<li>The long flush is saved to the database.  </li>
<li>The property <code>long_event_hide_on_dashboard</code> is set to <code>False</code>, so it <strong>won't appear on the Dashboard</strong>.  </li>
<li>A <strong>schedule is created in EventBridge</strong> to trigger the long flush later via the <code>LateLongFlush</code> Lambda.</li>
</ul>
</li>
</ol>
<hr />
<h3 id="notes">Notes</h3>
<ul>
<li>
<p>There is <strong>no information</strong> about gallons used in the flush in this uplink.<br />
  This data will arrive in a separate uplink of type <strong>Last Event Water Usage</strong> (<code>payload_type_id = 11</code>).</p>
</li>
<li>
<p>The device is renamed with a <code>-flow</code> suffix to distinguish Toilet Sensor data from Leak Sensor data,<br />
  since <strong>Senospace includes both sensor types</strong> in the same transmitter.</p>
</li>
</ul>
<hr />
<h2 id="input-source_2">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>long_flush_senospace_uplink_queue</code></strong></p>
<h2 id="output-destinations_2">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>SendAlertToiletNotification</code></strong>, <strong><code>LateLongFlush</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>senospace_alerts_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json_2">Input Format (JSON)</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;123&quot;,
    &quot;application_id&quot;: &quot;app2&quot;,
    &quot;dev_eui&quot;: &quot;1234&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T19:11:57.283046007Z&quot;,
    &quot;payload_type&quot;: &quot;Alert&quot;,
    &quot;payload_type_id&quot;: 10,
    &quot;alert_type&quot;: &quot;Pulse Counting (Long Event Alert)&quot;,
    &quot;current_status&quot;: 1,
    &quot;pulse_duration_trigger&quot;: 180000,
    &quot;frame_count&quot;: 3642
}
</code></pre>
<h1 id="lambda-function-process_water_usage_senospace">Lambda Function: <code>Process_water_usage_senospace</code></h1>
<h2 id="purpose_3">Purpose</h2>
<p>Only for Toilet Sensor Devices from Manufacture Senospace filtered by the uplinks of type WATER_USAGE (payload_type_id = 11).</p>
<h2 id="main-operations-and-algorithms_3">Main Operations and Algorithms:</h2>
<h3 id="how-does-water-usage-work">How Does Water Usage Work?</h3>
<p>Gallons_spent = Pulse_total_pulses * 0.264172</p>
<p>Water usage can occur after a normal flush or after a Long Flush.</p>
<p>If it is after a normal flush, then it simply records in the database that a flush occurred without needing to calculate when the flush started. However, there can be two types:</p>
<ul>
<li>Above 1 gallon: <strong>"normal flush"</strong></li>
<li>Equal to or less than 1 gallon: <strong>"escape"</strong> (value too low to be a real flush)</li>
</ul>
<p>If it is after a Long Flush, then:</p>
<ul>
<li>If the Long Flush has already been registered, then this Water Usage must be recorded at the moment the Long Flush started. The type of this flush must be <strong>"long"</strong>.</li>
<li>If the Long Flush has not yet been registered on the dashboard [see late long flush], then the Long Flush should not appear on the dashboard. Instead, it should appear as a normal flush, without the need to calculate when the flush started.</li>
</ul>
<hr />
<h2 id="input-source_3">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>water_usage_senospace_uplink_queue</code></strong></p>
<h2 id="output-destinations_3">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>SendAlertToiletNotification</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>senospace_alerts_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json_3">Input Format (JSON)</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;123&quot;,
    &quot;application_id&quot;: &quot;app1&quot;,
    &quot;dev_eui&quot;: &quot;1234&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T20:13:31.984311103Z&quot;,
    &quot;payload_type&quot;: &quot;Alert&quot;,
    &quot;payload_type_id&quot;: 11,
    &quot;alert_type&quot;: &quot;Pulse Counting Event (Last Event Usage)&quot;,
    &quot;humidity&quot;: 54.33,
    &quot;temperature&quot;: 23.64,
    &quot;pulse_device_type_id&quot;: 1,
    &quot;pulse_total_pulses&quot;: 2902,
    &quot;pulse_total_liters&quot;: 2.694521819870009,
    &quot;frame_count&quot;: 24465
}
</code></pre>
<h1 id="lambda-function-process_toilet_heartbeat_senospace">Lambda Function: <code>Process_toilet_heartbeat_senospace</code></h1>
<h2 id="purpose_4">Purpose</h2>
<p>Only for Toilet Sensor Devices from Manufacture Senospace filtered by the uplinks of type HEARTBEAT (payload_type_id = 9).</p>
<h2 id="main-operations-and-algorithms_4">Main Operations and Algorithms:</h2>
<h3 id="how-does-the-heartbeat-work">How Does the Heartbeat Work?</h3>
<p>The heartbeat shows what has occurred since the last heartbeat:</p>
<ul>
<li>Number of flushes  </li>
<li>Gallons spent  </li>
</ul>
<hr />
<p><strong>Note:</strong><br />
If a long flush is currently happening and has not yet finished, and a heartbeat is sent,<br />
then the gallons spent during this ongoing long flush are <strong>pre-calculated</strong>.</p>
<hr />
<h2 id="input-source_4">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>BrowanWaterLeakUplinkQueue</code></strong></p>
<h2 id="output-destinations_4">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>toilet_heartbeat_senospace_uplink_queue</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>senospace_alerts_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json_4">Input Format (JSON)</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;123&quot;,
    &quot;application_id&quot;: &quot;app1&quot;,
    &quot;dev_eui&quot;: &quot;1234&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T20:18:57.869425058Z&quot;,
    &quot;payload_type&quot;: &quot;Alert&quot;,
    &quot;payload_type_id&quot;: 9,
    &quot;alert_type&quot;: &quot;Pulse Counting (Total Events)&quot;,
    &quot;pulse_long_event_triggered&quot;: 0,
    &quot;pulse_alert_interval&quot;: 500,
    &quot;pulse_device_type_id&quot;: 1,
    &quot;pulse_total_events&quot;: 11,
    &quot;pulse_total_pulses&quot;: 11,
    &quot;pulse_total_liters&quot;: 0.01021355617455896,
    &quot;frame_count&quot;: 325
}
</code></pre>
<h1 id="lambda-function-process_alerts_senospace">Lambda Function: <code>Process_alerts_senospace</code></h1>
<h2 id="purpose_5">Purpose</h2>
<p>Only for Leak Sensor and Toilet Sensor Devices from Manufacture Senospace filtered by the uplinks of payload_type_id = 1,2,3,4,5,6,7,8 and 12.</p>
<h2 id="main-operations-and-algorithms_5">Main Operations and Algorithms:</h2>
<h3 id="processing-based-on-payload_type_id">Processing Based on <code>payload_type_id</code></h3>
<p>Depending on the <code>payload_type_id</code>, the processing is different:</p>
<ul>
<li>
<p><strong>payload_type_id = 1</strong> → Leak Detected External (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 2</strong> → Leak Detected Local (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 3</strong> → Tamper (LEAK SENSOR)<br />
  Saves the event. This uplink is sent when the device comes into contact with the magnet (not actual movement).</p>
</li>
<li>
<p><strong>payload_type_id = 4</strong> → Button Pressed (LEAK SENSOR)<br />
  Saves the event.</p>
</li>
<li>
<p><strong>payload_type_id = 5</strong> → High Temperature (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 6</strong> → Low Temperature (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 7</strong> → High Humidity (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 8</strong> → Low Humidity (LEAK SENSOR)<br />
  Saves the event and calls the Lambda <strong>SendAlertNotification</strong> to send an alert.</p>
</li>
<li>
<p><strong>payload_type_id = 12</strong> → Headphone Jack Alert (LEAK SENSOR)<br />
  Saves the event.</p>
</li>
</ul>
<hr />
<h2 id="input-source_5">Input Source</h2>
<p>Receives messages from the following SQS queue:<br />
<strong><code>alerts_senospace_uplink_queue</code></strong></p>
<h2 id="output-destinations_5">Output Destinations</h2>
<ul>
<li>Sends data to Lambda: <strong><code>SendAlertNotification</code></strong>, <strong><code>SendAlertToiletNotification</code></strong></li>
<li>Stores data in the following tables:</li>
<li><code>devices_details</code></li>
<li><code>senospace_data</code></li>
<li><code>senospace_alerts_data</code></li>
<li><code>devices_last_data</code></li>
</ul>
<hr />
<h2 id="input-format-json-example-only-for-payload_type_id-2">Input Format (JSON) - example only for payload_type_id = 2</h2>
<pre><code class="language-json">{
    &quot;device_id&quot;: &quot;123&quot;,
    &quot;application_id&quot;: &quot;app4&quot;,
    &quot;dev_eui&quot;: &quot;1234&quot;,
    &quot;read_time&quot;: &quot;2025-07-02T18:46:19.129642963Z&quot;,
    &quot;payload_type&quot;: &quot;Alert&quot;,
    &quot;payload_type_id&quot;: 2,
    &quot;alert_type&quot;: &quot;Local Leak Detection (Via Bottom Contact Pins)&quot;,
    &quot;current_status&quot;: 0,
    &quot;current_value&quot;: 3044,
    &quot;humidity&quot;: 49.23,
    &quot;temperature&quot;: 23.68,
    &quot;delay_count&quot;: 1,
    &quot;trigger_value&quot;: 5000,
    &quot;frame_count&quot;: 2789
}
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["navigation.instant", "navigation.tabs", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>